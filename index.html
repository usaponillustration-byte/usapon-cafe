<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>喫茶ステッカー（Sticker Cafe Game）</title>
<style>
  :root { --panel: #ffffffee; --ink:#3f3a37; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji"; background:#f4f4f5; color:var(--ink); }
  .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
  h1 { font-size: 22px; margin: 0 0 10px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:var(--panel); border:1px solid #e5e7eb; padding:10px; border-radius:16px; box-shadow: 0 4px 12px #0001; }
  .btn, label.btn { appearance: none; border:1px solid #d1d5db; border-radius: 9999px; padding:8px 12px; background:#fff; cursor:pointer; font-size: 14px; box-shadow: 0 1px 2px #0001; }
  .btn[disabled] { opacity:.5; cursor: default; }
  .board { position: relative; width:100%; aspect-ratio: 16 / 10; border-radius: 22px; overflow: hidden; box-shadow: 0 8px 24px #0003; user-select:none; }
  .bg-wall { position:absolute; inset:0; background: linear-gradient(#fff7e6, #f8e6bd); }
  .menu { position:absolute; left:50%; transform: translateX(-50%); top:18px; width:70%; height:160px; background:#fff8ee; border: 8px solid #4a372e; border-radius: 18px; display:flex; align-items:center; justify-content:center; color:#4a372ea6; font-size:14px; }
  .table { position:absolute; left:0; right:0; bottom:0; height:38%; background: linear-gradient(#b08968, #8d6e63); box-shadow: inset 0 12px 24px #0004; }
  .palette { margin-top: 10px; display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
  .card { border:1px solid #e5e7eb; border-radius: 14px; background:#fff; overflow:hidden; box-shadow: 0 4px 10px #0001; }
  .card button { display:block; width:100%; background:#fff; border:0; padding:0; cursor:pointer; }
  .card img { width:100%; height:120px; object-fit:contain; background:#fff; }
  .card .cap { padding:6px 8px; font-size: 12px; color:#6b7280; text-align:left; }
  .sticker { position:absolute; cursor:grab; transform-origin: top left; }
  .uibar { position:absolute; left:8px; top:8px; display:flex; gap:6px; background:var(--panel); padding:6px 8px; border-radius: 9999px; box-shadow: 0 6px 18px #0003; z-index: 999; }
  .uibar .btn { padding:6px 10px; }
  .hint { font-size: 12px; color:#6b7280; margin-top: 6px; }
  .help { font-size: 13px; color:#6b7280; background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding:10px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>喫茶ステッカー（Sticker Cafe Game）</h1>
  <div class="toolbar">
    <label class="btn">画像をアップロード<input id="uploader" class="hidden" type="file" accept="image/*" style="display:none"></label>
    <button id="exportBtn" class="btn">PNG書き出し</button>
    <button id="clearBtn" class="btn">ぜんぶ削除</button>
  </div>
  <p class="hint">画像をアップすると、そのままパレットに追加されます。</p>
  <div id="board" class="board">
    <div class="bg-wall"></div>
    <div class="menu">店名プレートをここに置くとそれっぽいよ</div>
    <div class="table"></div>
    <div id="ui" class="uibar" style="display:none" data-ui="controls">
      <button class="btn" data-act="bigger">＋</button>
      <button class="btn" data-act="smaller">－</button>
      <button class="btn" data-act="rotL">↺</button>
      <button class="btn" data-act="rotR">↻</button>
      <button class="btn" data-act="dup">⎘</button>
      <button class="btn" data-act="del" style="color:#b91c1c">削除</button>
    </div>
  </div>

  <h3 style="margin-top:12px">パレット</h3>
  <div id="palette" class="palette"></div>
  <div class="help" style="margin-top:10px">
    <details>
      <summary>使い方ヘルプ</summary>
      <ul>
        <li>「画像をアップロード」→ そのままパレットに追加されます。</li>
        <li>パレットのサムネイルをクリック → キャンバスに配置。配置後はドラッグで移動。</li>
        <li>左上のバーで拡大・縮小・回転・複製・削除。</li>
        <li>進捗はこのブラウザに自動保存。PNG書き出しで画像保存。</li>
      </ul>
    </details>
  </div>
</div>

<script>
(function(){
  const board = document.getElementById('board');
  const paletteEl = document.getElementById('palette');
  const uploader = document.getElementById('uploader');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const ui = document.getElementById('ui');

  const storage = {
    get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
    set(k, v){ try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
  };

  let palette = storage.get('scg_palette', []); // {name, src}
  let items = storage.get('scg_items', []);     // {id, src, x, y, scale, rot, z}
  let selectedId = null; let zCounter = 1;

  function save(){ storage.set('scg_palette', palette); storage.set('scg_items', items); }

  function el(tag, attrs) {
    const n = document.createElement(tag);
    if (attrs) Object.entries(attrs).forEach(([k,v]) => n.setAttribute(k,v));
    return n;
  }

  function renderPalette() {
    p

